<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login</title>
    <link rel="stylesheet" href="style.css" />

    <script type="text/javascript" src="validation.js" defer></script>
  </head>
  <body>
    <header>
      <nav class="navbar">
        <div class="navbar-container">
          <ul class="navbar-links">
            <li><a href="#" id="logout">Logout</a></li>

            <li class="dropdown" id="userDropdown">
              <button class="dropbtn" id="userDropdownBtn">
                Logged in as <span id="userName">Loading...</span>
              </button>
              <div class="dropdown-content" id="userDropdownContent">
                <p class="header"></p>
                <p><strong>Email:</strong> <span id="userEmail"></span></p>
                <p><strong>Role:</strong> <span id="userRole"></span></p>
                <p>
                  <strong>Pending Docs:</strong> <span id="pendingDocs"></span>
                </p>
                <p>
                  <strong>Quiz tokens</strong> <span id="userTokens"></span>
                </p>
              </div>
            </li>

            <li class="dropdown">
              <button class="dropbtn">
                Katalógus
                <i class="fa fa-caret-down"></i>
              </button>
              <div class="dropdown-content">
                <div class="header">
                  <h2>Fájlkategóriák</h2>
                </div>
                <div class="row" id="category-container">
                  <!-- A kategóriák és alkategóriák ide fognak betöltődni -->
                </div>
              </div>
            </li>
            <li><a href="/trending/trending.html">Főoldal</a></li>
            <li><a href="/allquizzes/allquizzes.html">Kvízek</a></li>
            <li>
              <a href="/quizzes/quizzes.html" id="myquizresults"
                >Kvízeredményeim</a
              >
            </li>
            <li>
              <a href="/moderation/moderation.html" id="moderation"
                >Moderáció</a
              >
            </li>
            <li><a href="/static/login.html" id="navbar-login">Login</a></li>
          </ul>
        </div>
      </nav>
    </header>

    <div id="loader-container" class="preloader" style="display: none">
      <div class="preloader__logo">
        <div class="preloader__circle"></div>
      </div>
    </div>
    <div class="wrapper">
      <h1>Login</h1>
      <p id="error-message"></p>
      <form id="form">
        <div>
          <label for="login_email">
            <span>@</span>
          </label>
          <input
            type="email"
            name="email"
            id="login_email"
            placeholder="Email"
          />
        </div>
        <div>
          <label for="login_password">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              height="24"
              viewBox="0 -960 960 960"
              width="24"
            >
              <path
                d="M240-80q-33 0-56.5-23.5T160-160v-400q0-33 23.5-56.5T240-640h40v-80q0-83 58.5-141.5T480-920q83 0 141.5 58.5T680-720v80h40q33 0 56.5 23.5T800-560v400q0 33-23.5 56.5T720-80H240Zm240-200q33 0 56.5-23.5T560-360q0-33-23.5-56.5T480-440q-33 0-56.5 23.5T400-360q0 33 23.5 56.5T480-280ZM360-640h240v-80q0-50-35-85t-85-35q-50 0-85 35t-35 85v80Z"
              />
            </svg>
          </label>
          <input
            type="password"
            name="password"
            id="login_password"
            placeholder="Password"
          />
        </div>
        <button type="submit">Login</button>

        <div id="verification_section" style="display: none">
          <h2 id="verification-message">Sikeres regisztráció!</h2>
          <h2 id="verification-message-2">
            Add meg az e-mailre küldött kódot!
          </h2>

          <input
            type="text"
            id="verification_code"
            placeholder="Írd be a kódot"
          />
          <button
            id="verification_code_submit"
            onclick="event.preventDefault(); verifyCode()"
          >
            Verifikálás
          </button>
          <br />
          <button onclick="event.preventDefault(); resendVerificationCode()">
            Kód újraküldése
          </button>
          <p id="next_resend_time"></p>
        </div>
        <button
          id="new_verification_button"
          type="button"
          onclick="startNewVerification()"
          style="display: none"
        >
          Új verifikáció indítása
        </button>
      </form>
      <p>New here? <a href="signup.html">Create an Account</a></p>
      <h2>Felhasználói adatok</h2>
      <button onclick="getUserData()">Felhasználói adatok lekérése</button>
      <p id="user_data"></p>
    </div>

    <script>
      window.onload = async function () {
        const token = localStorage.getItem("token");
        if (!token) {
          if (!token) {
            document.getElementById("auth-link").style.display = "block";
            return;
          }
        }

        const response = await fetch("/me", {
          method: "GET",
          headers: { Authorization: "Bearer " + token },
        });
      };

      // Dinamikus kategória betöltés
      async function loadCategories() {
        const response = await fetch("/categories");
        const categories = await response.json();

        const categoryContainer = document.getElementById("category-container");
        categoryContainer.innerHTML = "";
        categories.forEach((category) => {
          const categoryColumn = document.createElement("div");
          categoryColumn.classList.add("column");

          const categoryTitle = document.createElement("h3");
          categoryTitle.textContent = category.name;
          categoryColumn.appendChild(categoryTitle);

          category.children.forEach((subcategory) => {
            const subcategoryLink = document.createElement("a");
            subcategoryLink.href = "#";
            subcategoryLink.textContent = subcategory.name;

            // Eseménykezelő hozzáadása, hogy betöltsük az adott kategóriához tartozó fájlokat
            subcategoryLink.onclick = async (e) => {
              const dropdownContent =
                document.querySelector(".dropdown-content");
              dropdownContent.style.display =
                dropdownContent.style.display === "none" ||
                dropdownContent.style.display === ""
                  ? "block"
                  : "none";
              e.preventDefault();
              window.location.href = `/catalog/catalog.html?selectedCategoryId=${subcategory.id}`; // Az alábbi kódban ezt a category_id-t használjuk
            };

            categoryColumn.appendChild(subcategoryLink);
          });

          categoryContainer.appendChild(categoryColumn);
        });
      }

      window.onload = loadCategories; // Kategóriák betöltése oldal betöltésekor

      // Dropdown gombra hover eseményfigyelő hozzáadása
      document.querySelector(".dropbtn").addEventListener("mouseenter", () => {
        const dropdownContent = document.querySelector(".dropdown-content");
        dropdownContent.style.display = "block"; // Hoverkor megjelenítjük
      });

      document
        .querySelector(".dropdown-content")
        .addEventListener("mouseenter", () => {
          const dropdownContent = document.querySelector(".dropdown-content");
          dropdownContent.style.display = "block"; // Hoverkor megjelenítjük
        });
      document
        .querySelector(".dropdown-content")
        .addEventListener("mouseleave", () => {
          const dropdownContent = document.querySelector(".dropdown-content");
          dropdownContent.style.display = "none"; // Hoverkor megjelenítjük
        });

      // Dropdown gombra hoverről való eltávolítás (mouseleave)
      document.querySelector(".dropbtn").addEventListener("mouseleave", () => {
        const dropdownContent = document.querySelector(".dropdown-content");
        dropdownContent.style.display = "none"; // Hover elhagyásakor eltüntetjük
      });
    </script>
  </body>
</html>
